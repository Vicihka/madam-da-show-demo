<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 15px;
            color: #333;
        }
        
        .header {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
            color: #333;
        }
        
        .status-indicator {
            padding: 8px 16px;
            background: #e0e0e0;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator.connected {
            background: #4caf50;
            color: white;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .search-bar {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #2196F3;
        }
        
        .section {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        
        .order-card {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            position: relative;
        }
        
        .order-checkbox {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .quick-actions-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e0e0e0;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 18px;
        }
        
        .quick-actions-btn:hover {
            background: #d0d0d0;
        }
        
        .quick-actions-menu {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 180px;
            padding: 8px;
            display: none;
        }
        
        .quick-actions-menu.show {
            display: block;
        }
        
        .quick-action-item {
            padding: 10px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .quick-action-item:hover {
            background: #f0f0f0;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .order-number {
            font-size: 18px;
            font-weight: bold;
            color: #2196F3;
        }
        
        .order-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pending { background: #fff3cd; color: #856404; }
        .status-preparing { background: #d1ecf1; color: #0c5460; }
        .status-ready { background: #d4edda; color: #155724; }
        .status-out { background: #cce5ff; color: #004085; }
        
        .order-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-weight: 600;
            color: #333;
        }
        
        .order-items {
            background: #fff;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }
        
        .order-items-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .item-list {
            list-style: none;
        }
        
        .item-list li {
            padding: 6px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
        }
        
        .item-list li:last-child {
            border-bottom: none;
        }
        
        .order-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-primary { background: #2196F3; color: white; }
        .btn-primary:hover { background: #1976D2; }
        
        .btn-success { background: #4caf50; color: white; }
        .btn-success:hover { background: #45a049; }
        
        .btn-info { background: #17a2b8; color: white; }
        .btn-info:hover { background: #138496; }
        
        .btn-warning { background: #ff9800; color: white; }
        .btn-warning:hover { background: #f57c00; }
        
        .btn-print { background: #4caf50; color: white; }
        .btn-print:hover { background: #45a049; }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn.loading {
            position: relative;
            color: transparent;
        }
        
        .btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .toast.success { background: #4caf50; }
        .toast.error { background: #f44336; }
        .toast.warning { background: #ff9800; }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @media (max-width: 768px) {
            .order-info {
                grid-template-columns: 1fr;
            }
            
            .order-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üì¶ Employee Dashboard</h1>
        <div style="display: flex; align-items: center; gap: 12px;">
            <button onclick="refreshOrders(); showToast('Refreshing orders...', 'info');" style="background: rgba(0,0,0,0.05); border: 1px solid #ddd; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 14px;" title="Refresh Orders">
                üîÑ Refresh
            </button>
            <button id="soundToggle" onclick="toggleSound()" style="background: rgba(0,0,0,0.05); border: 1px solid #ddd; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 14px;" title="Toggle sound notifications">
                <span id="soundIcon">üîä</span> <span id="soundText">Sound ON</span>
            </button>
            <div class="status-indicator" id="wsStatus">
                <span id="wsIcon">üîÑ</span>
                <span id="wsText">Connecting...</span>
            </div>
        </div>
    </div>
    
    <div class="stats">
        <div class="stat">
            <div class="stat-number" id="statPending">{{ total_to_prepare }}</div>
            <div class="stat-label">To Prepare</div>
        </div>
        <div class="stat">
            <div class="stat-number" id="statPreparing">{{ total_preparing }}</div>
            <div class="stat-label">Preparing</div>
        </div>
        <div class="stat">
            <div class="stat-number" id="statReady">{{ total_ready }}</div>
            <div class="stat-label">Ready</div>
        </div>
        <div class="stat">
            <div class="stat-number" id="statOut">{{ total_out }}</div>
            <div class="stat-label">Out</div>
        </div>
        <div class="stat">
            <div class="stat-number" id="statDelivered">{{ orders_delivered_today|length }}</div>
            <div class="stat-label">Received</div>
        </div>
    </div>
    
    <div class="search-bar">
        <input type="text" id="searchInput" class="search-input" placeholder="üîç Search orders by number, name, or phone..." onkeyup="filterOrders()">
        <button onclick="document.getElementById('searchInput').value=''; filterOrders();" style="margin-left: 10px; padding: 10px 15px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;" title="Clear search">
            ‚úï Clear
        </button>
    </div>
    
    <!-- Orders to Prepare -->
    <div class="section">
        <h2 class="section-title">üìã Orders to Prepare <span id="countToPrepare">({{ total_to_prepare }})</span></h2>
        <div id="ordersToPrepare">
            {% if orders_to_prepare %}
                {% for order in orders_to_prepare %}
                    {% include 'app/employee_order_card.html' with order=order show_items=True %}
                {% endfor %}
            {% else %}
                <div class="empty-state">No orders to prepare</div>
            {% endif %}
        </div>
    </div>
    
    <!-- Orders Being Prepared -->
    <div class="section">
        <h2 class="section-title">‚öôÔ∏è Currently Preparing <span id="countPreparing">({{ total_preparing }})</span></h2>
        <div id="ordersPreparing">
            {% if orders_preparing %}
                {% for order in orders_preparing %}
                    {% include 'app/employee_order_card.html' with order=order show_items=True %}
                {% endfor %}
            {% else %}
                <div class="empty-state">No orders being prepared</div>
            {% endif %}
        </div>
    </div>
    
    <!-- Orders Ready for Delivery -->
    <div class="section">
        <h2 class="section-title">‚úÖ Ready for Delivery <span id="countReady">({{ total_ready }})</span></h2>
        <div id="ordersReady">
            {% if orders_ready %}
                {% for order in orders_ready %}
                    {% include 'app/employee_order_card.html' with order=order %}
                {% endfor %}
            {% else %}
                <div class="empty-state">No orders ready</div>
            {% endif %}
        </div>
    </div>
    
    <!-- Orders Out for Delivery -->
    <div class="section">
        <h2 class="section-title">üöö Out for Delivery <span id="countOut">({{ total_out }})</span></h2>
        <div id="ordersOut">
            {% if orders_out %}
                {% for order in orders_out %}
                    {% include 'app/employee_order_card.html' with order=order %}
                {% endfor %}
            {% else %}
                <div class="empty-state">No orders out</div>
            {% endif %}
        </div>
    </div>
    
    <!-- Customer Received -->
    <div class="section">
        <h2 class="section-title">‚úÖ Customer Received <span id="countDelivered">({{ orders_delivered_today|length }})</span></h2>
        <div id="ordersDelivered">
            {% if orders_delivered_today %}
                {% for order in orders_delivered_today %}
                    {% include 'app/employee_order_card.html' with order=order show_items=False %}
                {% endfor %}
            {% else %}
                <div class="empty-state">No orders received today</div>
            {% endif %}
        </div>
    </div>
    
    <script>
        // Helper functions
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        // Update Status Function
        window.updateStatus = async function(orderNumber, newStatus) {
            // Find and disable all buttons for this order
            const orderCard = document.querySelector(`[data-order="${orderNumber}"]`);
            const buttons = orderCard ? orderCard.querySelectorAll('.btn') : [];
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('loading');
            });
            
            try {
                const response = await fetch(`/api/employee/order/${orderNumber}/status/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast(`Order ${orderNumber} updated`, 'success');
                    // Don't call refreshOrders() - WebSocket will handle the update in real-time
                } else {
                    showToast('Error: ' + data.message, 'error');
                    // Re-enable buttons on error
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove('loading');
                    });
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
                // Re-enable buttons on error
                buttons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('loading');
                });
            }
        };
        
        // Confirm Payment
        window.confirmPayment = async function(orderNumber) {
            if (!confirm('Confirm payment received for order #' + orderNumber + '?')) return;
            
            // Find and disable confirm payment button
            const orderCard = document.querySelector(`[data-order="${orderNumber}"]`);
            const confirmBtn = orderCard ? orderCard.querySelector('button[onclick*="confirmPayment"]') : null;
            if (confirmBtn) {
                confirmBtn.disabled = true;
                confirmBtn.classList.add('loading');
            }
            
            try {
                const response = await fetch(`/api/employee/order/${orderNumber}/confirm-payment/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ notes: '' })
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast('Payment confirmed', 'success');
                    // Don't call refreshOrders() - WebSocket will handle the update in real-time
                } else {
                    showToast('Error: ' + data.message, 'error');
                    // Re-enable button on error
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.classList.remove('loading');
                    }
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
                // Re-enable button on error
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.classList.remove('loading');
                }
            }
        };
        
        // Missing functions required by order card template
        window.updateBulkActions = function() {
            // Placeholder - bulk actions not implemented in simplified version
            // This prevents errors when checkbox is clicked
        };
        
        window.showQuickActions = function(event, orderNumber) {
            event.stopPropagation();
            
            // Remove existing menu
            const existing = document.querySelector('.quick-actions-menu');
            if (existing) existing.remove();
            
            // Create menu
            const menu = document.createElement('div');
            menu.className = 'quick-actions-menu show';
            
            const orderCard = document.querySelector(`[data-order="${orderNumber}"]`);
            if (!orderCard) return;
            
            const rect = event.target.getBoundingClientRect();
            menu.style.left = (rect.right + 10) + 'px';
            menu.style.top = rect.top + 'px';
            
            // Get order details for menu
            const paymentMethod = orderCard.getAttribute('data-payment-method') || '';
            const customerPhone = orderCard.getAttribute('data-customer-phone') || '';
            
            let menuItems = '';
            
            // View Details
            menuItems += `<div class="quick-action-item" onclick="window.open('/employee/order/${orderNumber}/', '_blank'); this.closest('.quick-actions-menu').remove();">
                üëÅÔ∏è View Details
            </div>`;
            
            // Print QR (only for COD)
            if (paymentMethod === 'Cash on Delivery') {
                menuItems += `<div class="quick-action-item" onclick="window.open('/employee/order/${orderNumber}/print/', '_blank'); this.closest('.quick-actions-menu').remove();">
                    üñ®Ô∏è Print QR
                </div>`;
            }
            
            // Call Customer
            if (customerPhone) {
                const cleanPhone = customerPhone.replace(/\D/g, '');
                menuItems += `<div class="quick-action-item" onclick="window.location.href='tel:${cleanPhone}'; this.closest('.quick-actions-menu').remove();">
                    üìû Call Customer
                </div>`;
            }
            
            // Copy Order Number
            menuItems += `<div class="quick-action-item" onclick="navigator.clipboard.writeText('${orderNumber}'); showToast('Order number copied', 'success'); this.closest('.quick-actions-menu').remove();">
                üìã Copy Order Number
            </div>`;
            
            menu.innerHTML = menuItems;
            
            document.body.appendChild(menu);
            
            // Close on outside click
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }, { once: true });
            }, 100);
        };
        
        // Search/Filter
        function filterOrders() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const sections = ['ordersToPrepare', 'ordersPreparing', 'ordersReady', 'ordersOut', 'ordersDelivered'];
            
            sections.forEach(sectionId => {
                const container = document.getElementById(sectionId);
                if (!container) return;
                
                const cards = container.querySelectorAll('.order-card');
                let visible = 0;
                
                cards.forEach(card => {
                    const text = card.textContent.toLowerCase();
                    if (text.includes(search)) {
                        card.style.display = '';
                        visible++;
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        }
        
        // Update Counters
        function updateCounters() {
            const sections = {
                'ordersToPrepare': 'statPending',
                'ordersPreparing': 'statPreparing',
                'ordersReady': 'statReady',
                'ordersOut': 'statOut',
                'ordersDelivered': 'statDelivered'
            };
            
            Object.entries(sections).forEach(([sectionId, statId]) => {
                const section = document.getElementById(sectionId);
                const stat = document.getElementById(statId);
                const count = document.getElementById('count' + sectionId.replace('orders', ''));
                
                if (section && stat) {
                    const num = section.querySelectorAll('.order-card').length;
                    stat.textContent = num;
                    if (count) count.textContent = `(${num})`;
                }
            });
        }
        
        // Refresh Orders
        function refreshOrders() {
            fetch('/employee/api/')
                .then(r => r.json())
                .then(data => {
                    if (!data.success) return;
                    
                    // Update stats
                    document.getElementById('statPending').textContent = data.stats.total_to_prepare;
                    document.getElementById('statPreparing').textContent = data.stats.total_preparing;
                    document.getElementById('statReady').textContent = data.stats.total_ready;
                    document.getElementById('statOut').textContent = data.stats.total_out;
                    
                    // Update counts
                    document.getElementById('countToPrepare').textContent = `(${data.stats.total_to_prepare})`;
                    document.getElementById('countPreparing').textContent = `(${data.stats.total_preparing})`;
                    document.getElementById('countReady').textContent = `(${data.stats.total_ready})`;
                    document.getElementById('countOut').textContent = `(${data.stats.total_out})`;
                    
                    // Update sections
                    updateSection('ordersToPrepare', data.orders_to_prepare, true);
                    updateSection('ordersPreparing', data.orders_preparing, true);
                    updateSection('ordersReady', data.orders_ready, false);
                    updateSection('ordersOut', data.orders_out, false);
                    
                    if (data.orders_delivered) {
                        updateSection('ordersDelivered', data.orders_delivered, false);
                        document.getElementById('statDelivered').textContent = data.orders_delivered.length;
                        document.getElementById('countDelivered').textContent = `(${data.orders_delivered.length})`;
                    }
                })
                .catch(err => console.error('Refresh error:', err));
        }
        
        window.refreshOrders = refreshOrders;
        
        function updateSection(containerId, orders, showItems) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Get existing order numbers
            const existingOrders = new Set();
            container.querySelectorAll('.order-card').forEach(card => {
                existingOrders.add(card.getAttribute('data-order'));
            });
            
            // Add new orders that don't exist yet
            if (orders && orders.length > 0) {
                orders.forEach(order => {
                    // Skip if already exists
                    if (existingOrders.has(order.order_number)) return;
                    
                    // For active sections (not delivered), skip orders with customer_received=True
                    if (containerId !== 'ordersDelivered' && order.customer_received) {
                        return;
                    }
                    
                    // For delivered section, only show delivered status orders
                    if (containerId === 'ordersDelivered' && order.status !== 'delivered') {
                        return;
                    }
                    
                    // Add the order card
                    addOrderCard(containerId, order, showItems);
                });
            }
            
            updateCounters();
        }
        
        // Build order card HTML from order data
        function createOrderCardHTML(order, showItems = false) {
            const items = order.items || [];
            const itemsHTML = showItems && items.length > 0 ? `
                <div class="order-items">
                    <div class="order-items-title">üì¶ Products to Prepare:</div>
                    <ul class="item-list">
                        ${items.map(item => `
                            <li>
                                <span class="item-name">${item.product_name || item.name || 'Product'}</span>
                                <span class="item-qty">x${item.quantity}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            ` : '';
            
            const statusDisplay = order.status_display || order.status || 'Unknown';
            const statusClass = `status-${order.status || 'pending'}`;
            
            // Build actions HTML
            let actionsHTML = '';
            if (order.status === 'pending' || order.status === 'confirmed') {
                actionsHTML = `<button onclick="window.updateStatus('${order.order_number}', 'preparing')" class="btn btn-info">üë∑ Start Preparing</button>`;
            } else if (order.status === 'preparing') {
                if (order.payment_method === 'Cash on Delivery') {
                    actionsHTML += `<a href="/employee/order/${order.order_number}/print/" target="_blank" class="btn btn-print">üñ®Ô∏è Print QR</a>`;
                }
                actionsHTML += `<button onclick="window.updateStatus('${order.order_number}', 'ready_for_delivery')" class="btn btn-success">‚úÖ Mark Ready</button>`;
            } else if (order.status === 'ready_for_delivery') {
                actionsHTML = `<button onclick="window.updateStatus('${order.order_number}', 'out_for_delivery')" class="btn btn-warning">üöö Out for Delivery</button>`;
            } else if (order.status === 'out_for_delivery') {
                if (order.payment_method === 'Cash on Delivery' && !order.payment_received) {
                    actionsHTML += `<button onclick="window.confirmPayment('${order.order_number}')" class="btn btn-primary" style="background: #ffc107; color: #333;">üí∞ Confirm Payment ($${order.total_amount || order.total || '0'})</button>`;
                }
                actionsHTML += `<button onclick="window.updateStatus('${order.order_number}', 'delivered')" class="btn btn-success">‚úÖ Delivered</button>`;
            } else if (order.status === 'delivered' && order.payment_method === 'Cash on Delivery' && !order.payment_received) {
                actionsHTML = `<button onclick="window.confirmPayment('${order.order_number}')" class="btn btn-primary" style="background: #ffc107; color: #333;">üí∞ Confirm Payment ($${order.total_amount || order.total || '0'})</button>`;
            }
            
            const customerReceivedHTML = order.customer_received ? 
                '<span style="color: #28a745; font-weight: 600;">‚úÖ Received</span>' : 
                '<span style="color: #dc3545; font-weight: 600;">Not Received</span>';
            
            const paymentStatusHTML = order.payment_method === 'Cash on Delivery' ? `
                <div class="info-item">
                    <span class="info-label">Payment Status</span>
                    <span class="info-value">
                        ${order.payment_received ? 
                            '<span style="color: #28a745; font-weight: 600;">‚úÖ Paid</span>' : 
                            '<span style="color: #dc3545; font-weight: 600;">‚è≥ Not Paid</span>'}
                    </span>
                </div>
            ` : '';
            
            const timeAgo = getTimeAgo(order.created_at);
            
            return `
                <div class="order-card" data-order="${order.order_number}" 
                     data-customer-name="${(order.customer_name || '').toLowerCase()}" 
                     data-customer-phone="${(order.customer_phone || '').toLowerCase()}" 
                     data-payment-method="${order.payment_method || ''}" 
                     data-payment-received="${order.payment_received ? 'true' : 'false'}" 
                     data-total="${order.total_amount || order.total || '0'}" 
                     data-created-at="${order.created_at}">
                    <input type="checkbox" class="order-checkbox" data-order="${order.order_number}" onchange="window.updateBulkActions()">
                    <button class="quick-actions-btn" onclick="window.showQuickActions(event, '${order.order_number}')" title="Quick Actions">‚ãØ</button>
                    <div class="order-header">
                        <div>
                            <div class="order-number">#${order.order_number}</div>
                            <div class="time-ago">${timeAgo}</div>
                        </div>
                        <span class="order-status ${statusClass}">${statusDisplay}</span>
                    </div>
                    <div class="order-info">
                        <div class="info-item">
                            <span class="info-label">Customer</span>
                            <span class="info-value">${order.customer_name || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Phone</span>
                            <span class="info-value">${order.customer_phone || 'N/A'}</span>
                        </div>
                        ${order.customer_address ? `
                        <div class="info-item">
                            <span class="info-label">Address</span>
                            <span class="info-value">${order.customer_address}</span>
                        </div>
                        ` : ''}
                        ${order.customer_province ? `
                        <div class="info-item">
                            <span class="info-label">Province</span>
                            <span class="info-value">${order.customer_province}</span>
                        </div>
                        ` : ''}
                        <div class="info-item">
                            <span class="info-label">Total</span>
                            <span class="info-value">$${order.total_amount || order.total || '0'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Payment</span>
                            <span class="info-value">${order.payment_method || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Customer Received</span>
                            <span class="info-value">${customerReceivedHTML}</span>
                        </div>
                        ${paymentStatusHTML}
                        ${order.notes ? `
                        <div class="info-item" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                            <span class="info-label" style="color: #6b7280; font-weight: 600;">üìù Delivery Note</span>
                            <span class="info-value" style="color: #1f2937; white-space: pre-wrap; word-break: break-word;">${order.notes}</span>
                        </div>
                        ` : ''}
                    </div>
                    ${itemsHTML}
                    <div class="order-actions">${actionsHTML}</div>
                </div>
            `;
        }
        
        function getTimeAgo(isoString) {
            const time = new Date(isoString);
            const now = new Date();
            const diff = Math.floor((now - time) / 1000 / 60);
            if (diff < 1) return 'Just now';
            if (diff < 60) return `${diff} min ago`;
            if (diff < 1440) {
                const hours = Math.floor(diff / 60);
                return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            }
            const days = Math.floor(diff / 1440);
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }
        
        // Real-time WebSocket handlers
        function getSectionForStatus(status) {
            const map = {
                'pending': 'ordersToPrepare',
                'confirmed': 'ordersToPrepare',
                'preparing': 'ordersPreparing',
                'ready_for_delivery': 'ordersReady',
                'out_for_delivery': 'ordersOut',
                'delivered': 'ordersDelivered'
            };
            return map[status] || null;
        }
        
        function addOrderCard(sectionId, order, showItems) {
            const container = document.getElementById(sectionId);
            if (!container) return;
            
            // Check if already exists
            const existing = container.querySelector(`[data-order="${order.order_number}"]`);
            if (existing) return;
            
            // Validate: For active sections, don't add orders with customer_received=True
            if (sectionId !== 'ordersDelivered' && order.customer_received) {
                console.log(`Skipping order ${order.order_number} - customer already received`);
                return;
            }
            
            // Validate: For delivered section, only add delivered status orders
            if (sectionId === 'ordersDelivered' && order.status !== 'delivered') {
                console.log(`Skipping order ${order.order_number} - not delivered status`);
                return;
            }
            
            // Remove empty state
            const empty = container.querySelector('.empty-state');
            if (empty) empty.remove();
            
            // Create and add card
            const temp = document.createElement('div');
            temp.innerHTML = createOrderCardHTML(order, showItems);
            const card = temp.firstElementChild;
            if (card) {
                container.insertBefore(card, container.firstChild);
                updateCounters();
            }
        }
        
        // Sound notification settings
        let soundEnabled = localStorage.getItem('soundEnabled') !== 'false'; // Default: enabled
        let audioContext = null;
        let audioContextInitialized = false;
        
        // Initialize AudioContext on first user interaction
        function initAudioContext() {
            if (audioContextInitialized) return;
            
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioContextInitialized = true;
                console.log('AudioContext initialized');
            } catch (error) {
                console.warn('AudioContext initialization failed:', error);
            }
        }
        
        // Resume AudioContext if suspended (required by browser autoplay policy)
        async function resumeAudioContext() {
            if (!audioContext) {
                initAudioContext();
            }
            
            if (audioContext && audioContext.state === 'suspended') {
                try {
                    await audioContext.resume();
                    console.log('AudioContext resumed');
                } catch (error) {
                    console.warn('Failed to resume AudioContext:', error);
                }
            }
        }
        
        function toggleSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('soundEnabled', soundEnabled);
            updateSoundButton();
            
            // Initialize AudioContext on user interaction (click)
            if (soundEnabled) {
                initAudioContext();
                resumeAudioContext();
            }
        }
        
        function updateSoundButton() {
            const icon = document.getElementById('soundIcon');
            const text = document.getElementById('soundText');
            if (icon && text) {
                icon.textContent = soundEnabled ? 'üîä' : 'üîá';
                text.textContent = soundEnabled ? 'Sound ON' : 'Sound OFF';
            }
        }
        
        // Initialize sound button state
        updateSoundButton();
        
        // Initialize AudioContext on any user interaction
        document.addEventListener('click', function() {
            if (soundEnabled && !audioContextInitialized) {
                initAudioContext();
            }
        }, { once: true });
        
        // Sound notification for new orders - improved with better sound
        async function playNewOrderSound() {
            if (!soundEnabled) return;
            
            try {
                // Ensure AudioContext is initialized
                if (!audioContext) {
                    initAudioContext();
                }
                
                // Resume AudioContext if suspended (required by browser autoplay policy)
                await resumeAudioContext();
                
                // If AudioContext is still not ready, skip sound
                if (!audioContext || audioContext.state !== 'running') {
                    console.debug('AudioContext not ready, skipping sound');
                    return;
                }
                
                // Create a pleasant two-tone notification sound
                const playTone = (frequency, startTime, duration) => {
                    try {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.value = frequency;
                        oscillator.type = 'sine';
                        
                        gainNode.gain.setValueAtTime(0, startTime);
                        gainNode.gain.linearRampToValueAtTime(0.3, startTime + 0.01);
                        gainNode.gain.linearRampToValueAtTime(0, startTime + duration);
                        
                        oscillator.start(startTime);
                        oscillator.stop(startTime + duration);
                    } catch (error) {
                        console.warn('Error playing tone:', error);
                    }
                };
                
                // Play two-tone chime (pleasant notification sound)
                playTone(800, audioContext.currentTime, 0.15);
                playTone(1000, audioContext.currentTime + 0.15, 0.2);
                
            } catch (error) {
                console.debug('Sound playback error:', error);
            }
        }
        
        // Visual notification popup for new orders
        function showNewOrderNotification(orderNumber) {
            // Remove existing notification if any
            const existing = document.getElementById('newOrderNotification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.id = 'newOrderNotification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
                color: white;
                padding: 20px 25px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(244, 67, 54, 0.4);
                z-index: 10001;
                animation: slideInRight 0.4s ease-out;
                max-width: 350px;
                cursor: pointer;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 32px; animation: bounce 0.5s ease-in-out 3;">üîî</div>
                    <div style="flex: 1;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">New Order!</div>
                        <div style="font-size: 16px; opacity: 0.95;">Order #${orderNumber}</div>
                    </div>
                    <button onclick="this.closest('#newOrderNotification').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 16px; line-height: 1;">√ó</button>
                </div>
            `;
            
            // Add animation keyframes if not exists
            if (!document.getElementById('notificationStyles')) {
                const style = document.createElement('style');
                style.id = 'notificationStyles';
                style.textContent = `
                    @keyframes slideInRight {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @keyframes bounce {
                        0%, 100% { transform: translateY(0); }
                        50% { transform: translateY(-10px); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideInRight 0.4s ease-out reverse';
                    setTimeout(() => notification.remove(), 400);
                }
            }, 5000);
            
            // Click to dismiss
            notification.addEventListener('click', () => {
                notification.style.animation = 'slideInRight 0.4s ease-out reverse';
                setTimeout(() => notification.remove(), 400);
            });
        }
        
        function handleNewOrder(order) {
            console.log('New order received:', order.order_number);
            
            // Don't add if customer already received
            if (order.customer_received) {
                console.log('Order already received, skipping');
                return;
            }
            
            // Play sound notification
            playNewOrderSound();
            
            // Show visual notification
            showNewOrderNotification(order.order_number);
            
            // Show toast
            showToast(`New order: #${order.order_number}`, 'success');
            
            // Add to appropriate section based on status
            const sectionId = getSectionForStatus(order.status);
            if (sectionId) {
                const showItems = order.status === 'preparing' || order.status === 'pending' || order.status === 'confirmed';
                addOrderCard(sectionId, order, showItems);
            }
        }
        
        function handleStatusChanged(order, oldStatus, newStatus) {
            console.log(`Status changed: ${order.order_number} ${oldStatus} -> ${newStatus}`);
            
            // Remove from ALL sections first (in case it's in wrong section)
            ['ordersToPrepare', 'ordersPreparing', 'ordersReady', 'ordersOut', 'ordersDelivered'].forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    const card = section.querySelector(`[data-order="${order.order_number}"]`);
                    if (card) {
                        card.remove();
                        // Show empty state if needed
                        if (section.querySelectorAll('.order-card').length === 0) {
                            section.innerHTML = '<div class="empty-state">No orders</div>';
                        }
                    }
                }
            });
            
            // Add to new section (only if order should be in that section)
            const newSectionId = getSectionForStatus(newStatus);
            if (newSectionId) {
                // For active sections, don't add if customer_received=True
                if (newSectionId !== 'ordersDelivered' && order.customer_received) {
                    console.log(`Order ${order.order_number} has customer_received=True, not adding to ${newSectionId}`);
                    // If delivered, add to delivered section instead
                    if (newStatus === 'delivered') {
                        addOrderCard('ordersDelivered', order, false);
                    }
                    return;
                }
                
                const showItems = newStatus === 'preparing' || newStatus === 'pending' || newStatus === 'confirmed';
                addOrderCard(newSectionId, order, showItems);
            }
        }
        
        function handlePaymentConfirmed(order) {
            console.log('Payment confirmed:', order.order_number);
            
            // Update payment status in existing card
            const card = document.querySelector(`[data-order="${order.order_number}"]`);
            if (card) {
                // Update data attribute
                card.setAttribute('data-payment-received', order.payment_received ? 'true' : 'false');
                
                // Find payment status info item (look for label "Payment Status")
                const infoItems = card.querySelectorAll('.info-item');
                infoItems.forEach(item => {
                    const label = item.querySelector('.info-label');
                    if (label && label.textContent.trim() === 'Payment Status') {
                        const valueEl = item.querySelector('.info-value');
                        if (valueEl && order.payment_received) {
                            const paymentDate = order.payment_received_at ? 
                                new Date(order.payment_received_at).toLocaleDateString('en-US', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'}) : '';
                            valueEl.innerHTML = '<span style="color: #28a745; font-weight: 600;">‚úÖ Paid</span>' +
                                (paymentDate ? '<div style="font-size: 11px; color: #666; margin-top: 2px;">' + paymentDate + '</div>' : '');
                        }
                    }
                });
                
                // Remove confirm payment button
                const confirmBtn = card.querySelector('button[onclick*="confirmPayment"]');
                if (confirmBtn) confirmBtn.remove();
            }
            updateCounters();
        }
        
        // WebSocket
        let websocket = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        let reconnectTimeout = null;
        
        function connectWebSocket() {
            // Clear any existing reconnect timeout
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
            }
            
            // Stop trying if too many failed attempts
            if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                document.getElementById('wsIcon').textContent = '‚ö†Ô∏è';
                document.getElementById('wsText').textContent = 'WebSocket unavailable';
                document.getElementById('wsStatus').classList.remove('connected');
                console.warn('WebSocket: Max reconnection attempts reached. Server may not support WebSockets.');
                console.warn('SOLUTION: Stop current server (Ctrl+C) and run: START_SERVER_WEBSOCKET_DAPHNE.bat');
                
                // Show user-friendly message
                const statusEl = document.getElementById('wsStatus');
                if (statusEl) {
                    statusEl.title = 'WebSocket not available. Please restart server using START_SERVER_WEBSOCKET_DAPHNE.bat';
                }
                return;
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/orders/`;
            
            try {
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = () => {
                    reconnectAttempts = 0; // Reset on successful connection
                    document.getElementById('wsIcon').textContent = 'üü¢';
                    document.getElementById('wsText').textContent = 'Connected';
                    document.getElementById('wsStatus').classList.add('connected');
                    console.log('WebSocket connected');
                };
                
                websocket.onmessage = (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        console.log('WebSocket message:', data.type);
                        
                        if (data.type === 'new_order') {
                            handleNewOrder(data.order);
                        } else if (data.type === 'status_changed') {
                            handleStatusChanged(data.order, data.old_status, data.new_status);
                        } else if (data.type === 'payment_confirmed') {
                            handlePaymentConfirmed(data.order);
                        } else if (data.type === 'pong') {
                            // Keep-alive response
                        }
                    } catch (err) {
                        console.error('Error parsing WebSocket message:', err);
                    }
                };
                
                websocket.onerror = (error) => {
                    document.getElementById('wsIcon').textContent = 'üî¥';
                    document.getElementById('wsText').textContent = 'Error';
                    console.error('WebSocket error:', error);
                    reconnectAttempts++;
                };
                
                websocket.onclose = (event) => {
                    document.getElementById('wsIcon').textContent = 'üîÑ';
                    document.getElementById('wsText').textContent = reconnectAttempts < MAX_RECONNECT_ATTEMPTS ? 'Reconnecting...' : 'WebSocket unavailable';
                    document.getElementById('wsStatus').classList.remove('connected');
                    
                    // Only reconnect if not a normal closure and under max attempts
                    if (event.code !== 1000 && reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        console.log(`WebSocket closed (code: ${event.code}), reconnecting... (attempt ${reconnectAttempts + 1}/${MAX_RECONNECT_ATTEMPTS})`);
                        reconnectTimeout = setTimeout(connectWebSocket, 3000);
                    } else if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                        console.warn('WebSocket: Server does not support WebSockets.');
                        console.warn('SOLUTION:');
                        console.warn('1. Stop current server (Ctrl+C in terminal)');
                        console.warn('2. Run: START_SERVER_WEBSOCKET_DAPHNE.bat');
                        console.warn('3. Refresh this page');
                        
                        // Show alert to user
                        const statusEl = document.getElementById('wsStatus');
                        if (statusEl && !statusEl.dataset.alertShown) {
                            statusEl.dataset.alertShown = 'true';
                            setTimeout(() => {
                                alert('WebSocket connection failed!\n\nTo fix:\n1. Stop server (Ctrl+C)\n2. Run: START_SERVER_WEBSOCKET_DAPHNE.bat\n3. Refresh page');
                            }, 2000);
                        }
                    }
                };
            } catch (error) {
                console.error('WebSocket connection error:', error);
                reconnectAttempts++;
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectTimeout = setTimeout(connectWebSocket, 3000);
                }
            }
        }
        
        // Initialize
        connectWebSocket();
        
        // Update time-ago every minute
        setInterval(() => {
            document.querySelectorAll('.time-ago').forEach(el => {
                const card = el.closest('.order-card');
                if (card) {
                    const createdAt = card.getAttribute('data-created-at');
                    if (createdAt) {
                        el.textContent = getTimeAgo(createdAt);
                    }
                }
            });
        }, 60000); // Update every minute
        
        // Auto-refresh every 30 seconds as backup
        setInterval(refreshOrders, 30000);
        
        // Refresh on page focus
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) refreshOrders();
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Don't trigger when typing in input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            // R = Refresh
            if (e.key === 'r' || e.key === 'R') {
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    refreshOrders();
                    showToast('Refreshing...', 'info');
                }
            }
            
            // Escape = Clear search
            if (e.key === 'Escape') {
                const searchInput = document.getElementById('searchInput');
                if (searchInput && searchInput.value) {
                    searchInput.value = '';
                    filterOrders();
                }
            }
        });
    </script>
</body>
</html>
