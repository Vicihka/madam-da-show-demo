{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirm COD Payment</title>
    
    <link rel="stylesheet" href="{% static 'cod/css/cod_confirmation.css' %}">
    
    <!-- HTML5 QR Code Scanner Library (served locally to avoid tracking prevention warnings) -->
    <script src="{% static 'common/js/html5-qrcode.min.js' %}"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Confirm COD Payment</h1>
            <p>Scan QR code or enter order number</p>
        </div>
        
        {% if order %}
        <div class="order-info">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 48px; margin-bottom: 10px;">üì¶</div>
                <h3 style="color: #667eea; margin-bottom: 5px;">Order #{{ order.order_number }}</h3>
                <div style="font-size: 36px; color: #22c55e; font-weight: 700; margin: 15px 0;">${{ order.total }}</div>
            </div>
            
            <div class="info-row">
                <span class="info-label">Customer:</span>
                <span class="info-value">{{ order.customer_name }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Phone:</span>
                <span class="info-value">
                    <a href="tel:{{ order.customer_phone }}" style="color: #667eea; text-decoration: none;">{{ order.customer_phone }}</a>
                </span>
            </div>
            <div class="info-row">
                <span class="info-label">Address:</span>
                <span class="info-value" style="text-align: right; max-width: 60%;">{{ order.customer_address }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Province:</span>
                <span class="info-value">{{ order.customer_province }}</span>
            </div>
            
            {% if order.items.all %}
            <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #e0e0e0;">
                <div style="font-weight: 600; margin-bottom: 10px; color: #333;">Order Items:</div>
                {% for item in order.items.all %}
                <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px;">
                    <span>{{ item.product_name }} x{{ item.quantity }}</span>
                    <span style="color: #667eea; font-weight: 600;">${{ item.subtotal }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if order.payment_received %}
            <div class="success-message" style="margin-top: 20px;">
                <div style="font-size: 24px; margin-bottom: 5px;">‚úÖ</div>
                <div style="font-weight: 700;">Payment Already Confirmed</div>
                {% if order.payment_received_at %}
                <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">
                    Confirmed: {{ order.payment_received_at|date:"M d, Y H:i" }}
                </div>
                {% endif %}
                {% if order.payment_received_by %}
                <div style="font-size: 12px; opacity: 0.8;">
                    By: {{ order.payment_received_by }}
                </div>
                {% endif %}
            </div>
            {% else %}
            <form id="confirm-form" method="POST">
                {% csrf_token %}
                <input type="hidden" name="order_number" value="{{ order.order_number }}">
                
                <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <div style="font-weight: 700; color: #856404; margin-bottom: 5px;">‚ö†Ô∏è Verify Amount</div>
                    <div style="font-size: 14px; color: #856404;">Make sure you received exactly <strong>${{ order.total }}</strong> from the customer</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="driver_name">Your Name (Optional)</label>
                    <input type="text" class="form-input" id="driver_name" name="driver_name" placeholder="Enter your name">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="notes">Payment Notes (Optional)</label>
                    <textarea 
                        class="form-input" 
                        id="notes" 
                        name="notes" 
                        placeholder="Add any notes about the payment (e.g., 'Customer paid in cash', 'Received exact amount')"
                        rows="3"
                        style="resize: vertical; min-height: 80px;"
                        maxlength="500"
                    ></textarea>
                    <div style="font-size: 12px; color: #666; margin-top: 5px; text-align: right;">
                        <span id="notes-count">0</span>/500 characters
                    </div>
                </div>
                
                <button type="submit" class="btn" id="confirm-btn" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); margin-top: 20px;">
                    ‚úÖ Confirm Payment Received (${{ order.total }})
                </button>
            </form>
            {% endif %}
        </div>
        {% else %}
        <div style="margin-bottom: 20px;">
            <button onclick="startQRScan()" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-bottom: 15px;">
                üì∑ Scan QR Code
            </button>
            <div style="text-align: center; color: #666; margin: 10px 0; font-size: 14px;">OR</div>
        </div>
        
        <form id="order-form" method="GET" action="{% url 'cod_confirm' %}">
            <div class="form-group">
                <label class="form-label" for="order_number">Enter Order Number</label>
                <input 
                    type="text" 
                    class="form-input" 
                    id="order_number" 
                    name="order_number" 
                    placeholder="MD00001"
                    value="{{ order_number }}"
                    required
                    autofocus
                    style="text-transform: uppercase; font-size: 18px; text-align: center; letter-spacing: 2px;"
                    pattern="MD[0-9]+"
                    maxlength="20"
                >
                <div style="font-size: 12px; color: #666; margin-top: 5px; text-align: center;">
                    Format: MD followed by numbers (e.g., MD00001)
                </div>
            </div>
            
            <button type="submit" class="btn">üîç Find Order</button>
        </form>
        
        <div id="error-message" style="display: none; margin-top: 15px;"></div>
        {% endif %}
        
        <div id="message"></div>
        
        {% if auto_confirmed %}
        <div class="success-message" style="margin-top: 20px; animation: slideIn 0.5s;">
            <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
            <div style="font-weight: 700; font-size: 20px; margin-bottom: 5px;">Payment Auto-Confirmed!</div>
            <div style="font-size: 14px; color: #666;">QR code scanned and payment confirmed automatically</div>
        </div>
        {% endif %}
    </div>
    
    
    <script src="{% static 'cod/js/cod_confirmation.js' %}"></script>
</body>
</html>

