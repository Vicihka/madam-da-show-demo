<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Employee Dashboard</title>
    <!-- Fonts -->
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@300,400,500,700,900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* THEME: LIGHT DEFAULT */
            --bg-body: #f8fafc;
            --bg-sidebar: #ffffff;
            --bg-card: #ffffff;
            --bg-panel: #f1f5f9;
            --bg-surface: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --text-dim: #94a3b8;
            --border: #e2e8f0;
            --border-hover: #cbd5e1;

            /* Accent Colors */
            --primary: #2196F3;
            --primary-glow: rgba(33, 150, 243, 0.1);
            
            --s-pending: #f43f5e;
            --s-preparing: #f59e0b;
            --s-ready: #10b981;
            --s-out: #0ea5e9;
            --s-delivered: #8b5cf6;
            --s-pay: #10b981;

            --radius: 12px;
            --header-h: 64px;
            --sidebar-w: 260px;
        }

        [data-theme="dark"] {
            --bg-body: #09090b;
            --bg-sidebar: #0f0f11;
            --bg-card: #141417;
            --bg-panel: #18181b;
            --bg-surface: #27272a;
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            --text-dim: #52525b;
            --border: #27272a;
            --border-hover: #3f3f46;
            --primary-glow: rgba(33, 150, 243, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Satoshi', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; transition: background 0.3s ease; }
        
        /* SIDEBAR */
        .sidebar { width: var(--sidebar-w); background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 50; flex-shrink: 0; }
        @media(max-width: 1024px) { .sidebar { display: none; } }

        .brand-box { height: var(--header-h); display: flex; align-items: center; padding: 0 1.5rem; gap: 10px; font-weight: 800; font-size: 1.1rem; border-bottom: 1px solid var(--border); letter-spacing: -0.03em; }
        .nav-list { padding: 1.5rem 1rem; flex: 1; display: flex; flex-direction: column; gap: 6px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 14px; color: var(--text-muted); text-decoration: none; border-radius: 8px; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: 0.2s; }
        .nav-item:hover { background: var(--bg-surface); color: var(--text-main); }
        .nav-item.active { background: var(--primary-glow); color: var(--primary); border: 1px solid rgba(33, 150, 243, 0.2); }
        .user-mini { padding: 1rem; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .avatar { width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; }
        .logout-btn { width: 100%; padding: 8px 12px; background: var(--bg-surface); color: var(--text-main); border: 1px solid var(--border); border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: 0.2s; text-align: center; text-decoration: none; display: block; }
        .logout-btn:hover { background: #fee2e2; color: #dc2626; border-color: #fca5a5; }

        /* MAIN CONTENT */
        .main-view { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }

        header { height: var(--header-h); background: var(--bg-body); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; z-index: 40; }
        
        .search-wrap { position: relative; width: 350px; }
        .search-input { width: 100%; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-main); padding: 9px 12px 9px 40px; border-radius: 8px; outline: none; transition: 0.2s; font-size: 14px; }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-glow); }
        
        .header-actions { display: flex; gap: 8px; align-items: center; }
        .btn-icon { height: 38px; padding: 0 12px; border-radius: 8px; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; font-size: 14px; gap: 6px; font-weight: 500; }
        .btn-icon:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-1px); }
        .btn-icon.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .status-indicator { padding: 8px 16px; background: var(--bg-surface); border-radius: 20px; font-size: 12px; display: flex; align-items: center; gap: 8px; border: 1px solid var(--border); font-weight: 500; }
        .status-indicator.connected { background: #10b981; color: white; border-color: #10b981; }

        /* ANALYTICS */
        .analytics-strip { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; padding: 1.5rem 2rem 0 2rem; }
        .stat-box { background: var(--bg-card); border: 1px solid var(--border); padding: 16px; border-radius: 12px; display: flex; flex-direction: column; height: 90px; position: relative; overflow: hidden; transition: 0.2s; }
        .stat-box:hover { border-color: var(--border-hover); transform: translateY(-2px); }
        .stat-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; font-weight: 600; }
        .stat-val { font-size: 1.8rem; font-weight: 700; color: var(--text-main); margin-top: auto; }
        
        /* KANBAN BOARD */
        .control-bar { padding: 1.5rem 2rem 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .board-container { flex: 1; overflow-x: auto; padding: 0 2rem 2rem 2rem; display: flex; gap: 20px; align-items: flex-start; scrollbar-width: thin; }
        .board-container::-webkit-scrollbar { height: 8px; }
        .board-container::-webkit-scrollbar-track { background: transparent; }
        .board-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
        .board-container::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }
        
        .column { min-width: 340px; max-width: 380px; display: flex; flex-direction: column; flex-shrink: 0; }
        .col-header { padding: 12px 4px; display: flex; justify-content: space-between; border-bottom: 2px solid transparent; margin-bottom: 12px; color: var(--text-muted); font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .col-body { flex: 1; overflow-y: auto; padding-right: 4px; display: flex; flex-direction: column; gap: 12px; max-height: calc(100vh - 320px); }
        .col-body::-webkit-scrollbar { width: 6px; }
        .col-body::-webkit-scrollbar-track { background: transparent; }
        .col-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
        
        .badge-count { background: var(--bg-surface); color: var(--text-main); font-size: 0.75rem; padding: 2px 10px; border-radius: 12px; font-weight: 700; }
        
        /* CARD */
        .order-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; cursor: pointer; position: relative; transition: all 0.2s ease; user-select: none; }
        .order-card:hover { border-color: var(--border-hover); transform: translateY(-3px); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.2); }
        
        .card-top { display: flex; justify-content: space-between; margin-bottom: 12px; align-items: center; }
        .order-number { font-weight: 700; font-size: 0.95rem; color: var(--primary); }
        .time-badge { font-size: 0.7rem; color: var(--text-muted); background: var(--bg-surface); padding: 3px 8px; border-radius: 6px; font-weight: 600; }
        
        .customer-section { display: flex; gap: 10px; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .customer-info { flex: 1; }
        .customer-name { font-weight: 600; font-size: 0.9rem; color: var(--text-main); margin-bottom: 2px; }
        .customer-phone { font-size: 0.8rem; color: var(--text-muted); }
        
        .tags-row { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; align-items: center; }
        .tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 6px; font-weight: 600; border: 1px solid var(--border); }
        .tag.cod { background: rgba(245, 158, 11, 0.15); color: #f59e0b; border-color: rgba(245, 158, 11, 0.3); }
        .tag.paid { background: rgba(16, 185, 129, 0.15); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
        .tag.khqr { background: rgba(33, 150, 243, 0.15); color: #2196F3; border-color: rgba(33, 150, 243, 0.3); }
        
        .card-footer { display: flex; align-items: center; justify-content: space-between; padding-top: 12px; border-top: 1px solid var(--border); }
        .price { font-weight: 800; font-size: 1rem; color: var(--text-main); }
        
        /* CARD ACTION BUTTONS */
        .card-actions { display: flex; gap: 6px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); flex-wrap: wrap; }
        
        .btn-c { flex: 1; min-width: fit-content; padding: 8px 12px; border-radius: 6px; border: 1px solid transparent; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; white-space: nowrap; text-decoration: none; }
        
        .btn-c.process-btn { background: rgba(33, 150, 243, 0.1); color: #2196F3; border: 1px solid rgba(33, 150, 243, 0.2); }
        .btn-c.process-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        
        .btn-c.pay-btn { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2); }
        .btn-c.pay-btn:hover { background: var(--s-pay); color: white; border-color: var(--s-pay); }
        
        .btn-c.print-btn { background: var(--bg-surface); color: var(--text-muted); border-color: var(--border); }
        .btn-c.print-btn:hover { background: var(--border); color: var(--text-main); }
        
        .btn-c:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-c.loading { position: relative; color: transparent; }
        .btn-c.loading::after {
            content: ''; position: absolute; width: 14px; height: 14px; top: 50%; left: 50%; margin-left: -7px; margin-top: -7px;
            border: 2px solid currentColor; border-radius: 50%; border-top-color: transparent; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .empty-col { text-align: center; padding: 3rem 1rem; color: var(--text-muted); }
        .empty-icon { font-size: 2.5rem; margin-bottom: 10px; opacity: 0.3; }
        
        /* TOAST */
        .toast { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px; animation: slideIn 0.3s ease-out; }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        .toast.warning { background: #f59e0b; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* NOTIFICATION POPUP */
        .new-order-notification { position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 20px 25px; border-radius: 12px; box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4); z-index: 10001; animation: slideIn 0.4s ease-out; max-width: 350px; cursor: pointer; }
        .notification-content { display: flex; align-items: center; gap: 12px; }
        .notification-icon { font-size: 32px; animation: bounce 0.5s ease-in-out 3; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .search-wrap { display: none; }
            .analytics-strip { grid-template-columns: repeat(2, 1fr); }
            .column { min-width: 85vw; }
        }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="brand-box">üì¶ Order Manager</div>
        <div class="nav-list">
            <a class="nav-item active">üìä Dashboard</a>
            <a class="nav-item">üõçÔ∏è Orders</a>
            <a class="nav-item">üë• Customers</a>
            <a class="nav-item">üìà Analytics</a>
        </div>
        <div class="user-mini">
            <div class="user-info">
                <div class="avatar">{{ user.username.0|upper }}{{ user.username.1|upper }}</div>
                <div>
                    <div style="font-weight: 600; font-size: 0.9rem;">{{ user.username }}</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">
                        {% if user.is_staff %}Admin{% else %}Employee{% endif %}
                    </div>
                </div>
            </div>
            <a href="{% url 'employee_logout' %}" class="logout-btn">üö™ Logout</a>
        </div>
    </aside>

    <div class="main-view">
        <header>
            <div style="display:flex;align-items:center;gap:15px; font-weight:700; font-size: 1.1rem;">
                <span>Orders Overview</span>
            </div>
            <div class="search-wrap">
                <span style="position:absolute; left:14px; top:12px; color:var(--text-muted);">üîç</span>
                <input type="text" id="searchInput" class="search-input" placeholder="Search orders by number, name, phone..." onkeyup="filterOrders()">
            </div>
            <div class="header-actions">
                <button class="btn-icon" onclick="refreshOrders(); showToast('Refreshing orders...', 'success');" title="Refresh Orders">
                    <span>üîÑ</span> Refresh
                </button>
                <button class="btn-icon" id="soundToggle" onclick="toggleSound()" title="Toggle sound notifications">
                    <span id="soundIcon">üîä</span> <span id="soundText">Sound</span>
                </button>
                <button class="btn-icon" onclick="toggleTheme()">
                    <span id="themeIcon">üåô</span>
                </button>
                <div class="status-indicator" id="wsStatus">
                    <span id="wsIcon">üîÑ</span>
                    <span id="wsText">Connecting...</span>
                </div>
            </div>
        </header>

        <!-- DASHBOARD STATS -->
        <div class="analytics-strip">
            <div class="stat-box">
                <div class="stat-label">To Prepare</div>
                <div class="stat-val" id="statPending">{{ total_to_prepare }}</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Preparing</div>
                <div class="stat-val" id="statPreparing">{{ total_preparing }}</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Ready</div>
                <div class="stat-val" id="statReady">{{ total_ready }}</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Out for Delivery</div>
                <div class="stat-val" id="statOut">{{ total_out }}</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Delivered Today</div>
                <div class="stat-val" id="statDelivered">{{ orders_delivered_today|length }}</div>
            </div>
        </div>

        <!-- KANBAN BOARD -->
        <div class="control-bar">
            <h2 style="font-size:1.1rem; font-weight:700;">Active Orders</h2>
        </div>
        
        <div class="board-container">
            <!-- Column 1: To Prepare -->
            <div class="column">
                <div class="col-header" style="color:var(--s-pending); border-bottom-color: var(--s-pending);">
                    <span>üìã To Prepare</span>
                    <span class="badge-count" id="badge-pending">{{ total_to_prepare }}</span>
                </div>
                <div class="col-body" id="col-pending">
                    {% if orders_to_prepare %}
                        {% for order in orders_to_prepare %}
                            {% include 'app/employee/components/order_card_kanban.html' with order=order show_items=True %}
                        {% endfor %}
                    {% else %}
                        <div class="empty-col"><div class="empty-icon">üì≠</div><div>No orders</div></div>
                    {% endif %}
                </div>
            </div>

            <!-- Column 2: Preparing -->
            <div class="column">
                <div class="col-header" style="color:var(--s-preparing); border-bottom-color: var(--s-preparing);">
                    <span>üë®‚Äçüç≥ Preparing</span>
                    <span class="badge-count" id="badge-preparing">{{ total_preparing }}</span>
                </div>
                <div class="col-body" id="col-preparing">
                    {% if orders_preparing %}
                        {% for order in orders_preparing %}
                            {% include 'app/employee/components/order_card_kanban.html' with order=order show_items=True %}
                        {% endfor %}
                    {% else %}
                        <div class="empty-col"><div class="empty-icon">üì≠</div><div>No orders</div></div>
                    {% endif %}
                </div>
            </div>

            <!-- Column 3: Ready -->
            <div class="column">
                <div class="col-header" style="color:var(--s-ready); border-bottom-color: var(--s-ready);">
                    <span>‚úÖ Ready</span>
                    <span class="badge-count" id="badge-ready">{{ total_ready }}</span>
                </div>
                <div class="col-body" id="col-ready">
                    {% if orders_ready %}
                        {% for order in orders_ready %}
                            {% include 'app/employee/components/order_card_kanban.html' with order=order %}
                        {% endfor %}
                    {% else %}
                        <div class="empty-col"><div class="empty-icon">üì≠</div><div>No orders</div></div>
                    {% endif %}
                </div>
            </div>

            <!-- Column 4: Out for Delivery -->
            <div class="column">
                <div class="col-header" style="color:var(--s-out); border-bottom-color: var(--s-out);">
                    <span>üöö Delivering</span>
                    <span class="badge-count" id="badge-out">{{ total_out }}</span>
                </div>
                <div class="col-body" id="col-out">
                    {% if orders_out %}
                        {% for order in orders_out %}
                            {% include 'app/employee/components/order_card_kanban.html' with order=order %}
                        {% endfor %}
                    {% else %}
                        <div class="empty-col"><div class="empty-icon">üì≠</div><div>No orders</div></div>
                    {% endif %}
                </div>
            </div>

            <!-- Column 5: Delivered -->
            <div class="column">
                <div class="col-header" style="color:var(--s-delivered); border-bottom-color: var(--s-delivered);">
                    <span>üéâ Delivered</span>
                    <span class="badge-count" id="badge-delivered">{{ orders_delivered_today|length }}</span>
                </div>
                <div class="col-body" id="col-delivered">
                    {% if orders_delivered_today %}
                        {% for order in orders_delivered_today %}
                            {% include 'app/employee/components/order_card_kanban.html' with order=order show_items=False %}
                        {% endfor %}
                    {% else %}
                        <div class="empty-col"><div class="empty-icon">üì≠</div><div>No orders</div></div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
        // Helper functions
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        // Update Status Function
        window.updateStatus = async function(orderNumber, newStatus) {
            const orderCard = document.querySelector(`[data-order="${orderNumber}"]`);
            const buttons = orderCard ? orderCard.querySelectorAll('.btn-c') : [];
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('loading');
            });
            
            try {
                const response = await fetch(`/api/employee/order/${orderNumber}/status/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast(`Order ${orderNumber} updated`, 'success');
                } else {
                    showToast('Error: ' + data.message, 'error');
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove('loading');
                    });
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
                buttons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('loading');
                });
            }
        };
        
        // Confirm Payment
        window.confirmPayment = async function(orderNumber) {
            if (!confirm('Confirm payment received for order #' + orderNumber + '?')) return;
            
            const orderCard = document.querySelector(`[data-order="${orderNumber}"]`);
            const confirmBtn = orderCard ? orderCard.querySelector('button[onclick*="confirmPayment"]') : null;
            if (confirmBtn) {
                confirmBtn.disabled = true;
                confirmBtn.classList.add('loading');
            }
            
            try {
                const response = await fetch(`/api/employee/order/${orderNumber}/confirm-payment/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ notes: '' })
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast('Payment confirmed', 'success');
                } else {
                    showToast('Error: ' + data.message, 'error');
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.classList.remove('loading');
                    }
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.classList.remove('loading');
                }
            }
        };
        
        // Search/Filter
        function filterOrders() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.order-card').forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(search) ? '' : 'none';
            });
        }
        
        // Update Counters
        function updateCounters() {
            const columns = {
                'col-pending': 'statPending',
                'col-preparing': 'statPreparing',
                'col-ready': 'statReady',
                'col-out': 'statOut',
                'col-delivered': 'statDelivered'
            };
            
            Object.entries(columns).forEach(([colId, statId]) => {
                const col = document.getElementById(colId);
                const stat = document.getElementById(statId);
                const badge = document.getElementById('badge-' + colId.replace('col-', ''));
                
                if (col && stat) {
                    const count = col.querySelectorAll('.order-card').length;
                    stat.textContent = count;
                    if (badge) badge.textContent = count;
                }
            });
        }
        
        // Refresh Orders
        function refreshOrders() {
            fetch('/employee/api/')
                .then(r => r.json())
                .then(data => {
                    if (!data.success) return;
                    
                    document.getElementById('statPending').textContent = data.stats.total_to_prepare;
                    document.getElementById('statPreparing').textContent = data.stats.total_preparing;
                    document.getElementById('statReady').textContent = data.stats.total_ready;
                    document.getElementById('statOut').textContent = data.stats.total_out;
                    
                    updateSection('col-pending', data.orders_to_prepare, true);
                    updateSection('col-preparing', data.orders_preparing, true);
                    updateSection('col-ready', data.orders_ready, false);
                    updateSection('col-out', data.orders_out, false);
                    
                    if (data.orders_delivered) {
                        updateSection('col-delivered', data.orders_delivered, false);
                        document.getElementById('statDelivered').textContent = data.orders_delivered.length;
                        document.getElementById('badge-delivered').textContent = data.orders_delivered.length;
                    }
                })
                .catch(err => console.error('Refresh error:', err));
        }
        
        window.refreshOrders = refreshOrders;
        
        function updateSection(containerId, orders, showItems) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const existingOrders = new Set();
            container.querySelectorAll('.order-card').forEach(card => {
                existingOrders.add(card.getAttribute('data-order'));
            });
            
            if (orders && orders.length > 0) {
                orders.forEach(order => {
                    if (existingOrders.has(order.order_number)) return;
                    if (containerId !== 'col-delivered' && order.customer_received) return;
                    if (containerId === 'col-delivered' && order.status !== 'delivered') return;
                    
                    addOrderCard(containerId, order, showItems);
                });
            }
            
            updateCounters();
        }
        
        function createOrderCardHTML(order, showItems = false) {
            const timeAgo = getTimeAgo(order.created_at);
            
            const items = order.items || [];
            const itemsPreview = items.slice(0, 2).map(item => 
                `<div style="font-size: 0.75rem; color: var(--text-muted); padding: 2px 0;">‚Ä¢ ${item.product_name || item.name || 'Product'} x${item.quantity}</div>`
            ).join('');
            const moreItems = items.length > 2 ? `<div style="font-size: 0.7rem; color: var(--text-dim); padding: 2px 0;">+${items.length - 2} more items</div>` : '';
            
            let actionsHTML = '';
            if (order.status === 'pending' || order.status === 'confirmed') {
                actionsHTML = `<button onclick="window.updateStatus('${order.order_number}', 'preparing')" class="btn-c process-btn">üë®‚Äçüç≥ Start</button>`;
            } else if (order.status === 'preparing') {
                if (order.payment_method === 'Cash on Delivery') {
                    actionsHTML += `<a href="/employee/order/${order.order_number}/print/" target="_blank" class="btn-c print-btn">üñ®Ô∏è</a>`;
                }
                actionsHTML += `<button onclick="window.updateStatus('${order.order_number}', 'ready_for_delivery')" class="btn-c process-btn">‚úÖ Ready</button>`;
            } else if (order.status === 'ready_for_delivery') {
                actionsHTML = `<button onclick="window.updateStatus('${order.order_number}', 'out_for_delivery')" class="btn-c process-btn">üöö Ship</button>`;
            } else if (order.status === 'out_for_delivery') {
                if (order.payment_method === 'Cash on Delivery' && !order.payment_received) {
                    actionsHTML += `<button onclick="window.confirmPayment('${order.order_number}')" class="btn-c pay-btn">üí∞ Pay</button>`;
                }
                actionsHTML += `<button onclick="window.updateStatus('${order.order_number}', 'delivered')" class="btn-c process-btn">‚úÖ Done</button>`;
            } else if (order.status === 'delivered' && order.payment_method === 'Cash on Delivery' && !order.payment_received) {
                actionsHTML = `<button onclick="window.confirmPayment('${order.order_number}')" class="btn-c pay-btn">üí∞ Confirm Payment</button>`;
            }
            
            const paymentTag = order.payment_method === 'Cash on Delivery' ? 
                `<span class="tag cod">üíµ COD</span>` : 
                `<span class="tag khqr">üì± ${order.payment_method || 'Paid'}</span>`;
            
            const paidTag = (order.payment_received || order.payment_method !== 'Cash on Delivery') ? 
                `<span class="tag paid">‚úÖ Paid</span>` : '';
            
            return `
                <div class="order-card" data-order="${order.order_number}" 
                     data-customer-name="${(order.customer_name || '').toLowerCase()}" 
                     data-customer-phone="${(order.customer_phone || '').toLowerCase()}">
                    <div class="card-top">
                        <span class="order-number">#${order.order_number}</span>
                        <span class="time-badge" data-time="${order.created_at}">${timeAgo}</span>
                    </div>
                    <div class="customer-section">
                        <div class="avatar">${getInitials(order.customer_name || 'U')}</div>
                        <div class="customer-info">
                            <div class="customer-name">${order.customer_name || 'Unknown'}</div>
                            <div class="customer-phone">${order.customer_phone || 'No phone'}</div>
                        </div>
                    </div>
                    <div class="tags-row">
                        ${paymentTag}
                        ${paidTag}
                    </div>
                    ${showItems && items.length > 0 ? `<div style="margin-bottom: 10px;">${itemsPreview}${moreItems}</div>` : ''}
                    <div class="card-footer">
                        <div class="price">$${order.total_amount || order.total || '0'}</div>
                    </div>
                    ${actionsHTML ? `<div class="card-actions">${actionsHTML}</div>` : ''}
                </div>
            `;
        }
        
        function getTimeAgo(isoString) {
            const time = new Date(isoString);
            const now = new Date();
            const diff = Math.floor((now - time) / 1000 / 60);
            if (diff < 1) return 'Just now';
            if (diff < 60) return `${diff}m ago`;
            if (diff < 1440) {
                const hours = Math.floor(diff / 60);
                return `${hours}h ago`;
            }
            const days = Math.floor(diff / 1440);
            return `${days}d ago`;
        }
        
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }
        
        function getSectionForStatus(status) {
            const map = {
                'pending': 'col-pending',
                'confirmed': 'col-pending',
                'preparing': 'col-preparing',
                'ready_for_delivery': 'col-ready',
                'out_for_delivery': 'col-out',
                'delivered': 'col-delivered'
            };
            return map[status] || null;
        }
        
        function addOrderCard(sectionId, order, showItems) {
            const container = document.getElementById(sectionId);
            if (!container) return;
            
            const existing = container.querySelector(`[data-order="${order.order_number}"]`);
            if (existing) return;
            
            if (sectionId !== 'col-delivered' && order.customer_received) return;
            if (sectionId === 'col-delivered' && order.status !== 'delivered') return;
            
            const empty = container.querySelector('.empty-col');
            if (empty) empty.remove();
            
            const temp = document.createElement('div');
            temp.innerHTML = createOrderCardHTML(order, showItems);
            const card = temp.firstElementChild;
            if (card) {
                container.insertBefore(card, container.firstChild);
                updateCounters();
            }
        }
        
        // Sound notification
        let soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
        let audioContext = null;
        let audioContextInitialized = false;
        
        function initAudioContext() {
            if (audioContextInitialized) return;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioContextInitialized = true;
            } catch (error) {
                console.warn('AudioContext initialization failed:', error);
            }
        }
        
        async function resumeAudioContext() {
            if (!audioContext) initAudioContext();
            if (audioContext && audioContext.state === 'suspended') {
                try {
                    await audioContext.resume();
                } catch (error) {
                    console.warn('Failed to resume AudioContext:', error);
                }
            }
        }
        
        function toggleSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('soundEnabled', soundEnabled);
            updateSoundButton();
            if (soundEnabled) {
                initAudioContext();
                resumeAudioContext();
            }
        }
        
        function updateSoundButton() {
            const icon = document.getElementById('soundIcon');
            const text = document.getElementById('soundText');
            if (icon && text) {
                icon.textContent = soundEnabled ? 'üîä' : 'üîá';
                text.textContent = 'Sound';
            }
        }
        
        updateSoundButton();
        document.addEventListener('click', function() {
            if (soundEnabled && !audioContextInitialized) initAudioContext();
        }, { once: true });
        
        async function playNewOrderSound() {
            if (!soundEnabled) return;
            try {
                if (!audioContext) initAudioContext();
                await resumeAudioContext();
                if (!audioContext || audioContext.state !== 'running') return;
                
                const playTone = (frequency, startTime, duration) => {
                    try {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        oscillator.frequency.value = frequency;
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0, startTime);
                        gainNode.gain.linearRampToValueAtTime(0.3, startTime + 0.01);
                        gainNode.gain.linearRampToValueAtTime(0, startTime + duration);
                        oscillator.start(startTime);
                        oscillator.stop(startTime + duration);
                    } catch (error) {}
                };
                
                playTone(800, audioContext.currentTime, 0.15);
                playTone(1000, audioContext.currentTime + 0.15, 0.2);
            } catch (error) {}
        }
        
        function showNewOrderNotification(orderNumber) {
            const existing = document.getElementById('newOrderNotification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.id = 'newOrderNotification';
            notification.className = 'new-order-notification';
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">üîî</div>
                    <div style="flex: 1;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">New Order!</div>
                        <div style="font-size: 16px; opacity: 0.95;">Order #${orderNumber}</div>
                    </div>
                    <button onclick="this.closest('#newOrderNotification').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 16px; line-height: 1;">√ó</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
            notification.addEventListener('click', () => notification.remove());
        }
        
        function handleNewOrder(order) {
            if (order.customer_received) return;
            playNewOrderSound();
            showNewOrderNotification(order.order_number);
            showToast(`New order: #${order.order_number}`, 'success');
            
            const sectionId = getSectionForStatus(order.status);
            if (sectionId) {
                const showItems = order.status === 'preparing' || order.status === 'pending' || order.status === 'confirmed';
                addOrderCard(sectionId, order, showItems);
            }
        }
        
        function handleStatusChanged(order, oldStatus, newStatus) {
            ['col-pending', 'col-preparing', 'col-ready', 'col-out', 'col-delivered'].forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    const card = section.querySelector(`[data-order="${order.order_number}"]`);
                    if (card) {
                        card.remove();
                        if (section.querySelectorAll('.order-card').length === 0) {
                            section.innerHTML = '<div class="empty-col"><div class="empty-icon">üì≠</div><div>No orders</div></div>';
                        }
                    }
                }
            });
            
            const newSectionId = getSectionForStatus(newStatus);
            if (newSectionId) {
                if (newSectionId !== 'col-delivered' && order.customer_received) {
                    if (newStatus === 'delivered') {
                        addOrderCard('col-delivered', order, false);
                    }
                    return;
                }
                
                const showItems = newStatus === 'preparing' || newStatus === 'pending' || newStatus === 'confirmed';
                addOrderCard(newSectionId, order, showItems);
            }
        }
        
        function handlePaymentConfirmed(order) {
            const card = document.querySelector(`[data-order="${order.order_number}"]`);
            if (card) {
                const confirmBtn = card.querySelector('button[onclick*="confirmPayment"]');
                if (confirmBtn) confirmBtn.remove();
                
                const tagsRow = card.querySelector('.tags-row');
                if (tagsRow && !tagsRow.querySelector('.tag.paid')) {
                    tagsRow.innerHTML += '<span class="tag paid">‚úÖ Paid</span>';
                }
            }
            updateCounters();
        }
        
        // WebSocket
        let websocket = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        let reconnectTimeout = null;
        
        function connectWebSocket() {
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
            }
            
            if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                document.getElementById('wsIcon').textContent = '‚ö†Ô∏è';
                document.getElementById('wsText').textContent = 'WS Off';
                document.getElementById('wsStatus').classList.remove('connected');
                return;
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/orders/`;
            
            try {
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = () => {
                    reconnectAttempts = 0;
                    document.getElementById('wsIcon').textContent = 'üü¢';
                    document.getElementById('wsText').textContent = 'Live';
                    document.getElementById('wsStatus').classList.add('connected');
                };
                
                websocket.onmessage = (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        if (data.type === 'new_order') {
                            handleNewOrder(data.order);
                        } else if (data.type === 'status_changed') {
                            handleStatusChanged(data.order, data.old_status, data.new_status);
                        } else if (data.type === 'payment_confirmed') {
                            handlePaymentConfirmed(data.order);
                        }
                    } catch (err) {
                        console.error('Error parsing WebSocket message:', err);
                    }
                };
                
                websocket.onerror = (error) => {
                    document.getElementById('wsIcon').textContent = 'üî¥';
                    document.getElementById('wsText').textContent = 'Error';
                    reconnectAttempts++;
                };
                
                websocket.onclose = (event) => {
                    document.getElementById('wsIcon').textContent = 'üîÑ';
                    document.getElementById('wsText').textContent = reconnectAttempts < MAX_RECONNECT_ATTEMPTS ? 'Retry...' : 'WS Off';
                    document.getElementById('wsStatus').classList.remove('connected');
                    
                    if (event.code !== 1000 && reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        reconnectTimeout = setTimeout(connectWebSocket, 3000);
                    }
                };
            } catch (error) {
                reconnectAttempts++;
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectTimeout = setTimeout(connectWebSocket, 3000);
                }
            }
        }
        
        // Theme toggle
        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('themeIcon').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        }
        
        // Load saved theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
        }
        
        // Initialize
        connectWebSocket();
        
        // Update time badges every minute
        setInterval(() => {
            document.querySelectorAll('.time-badge').forEach(el => {
                const timeData = el.getAttribute('data-time');
                if (timeData) {
                    el.textContent = getTimeAgo(timeData);
                }
            });
        }, 60000);
        
        setInterval(refreshOrders, 30000);
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) refreshOrders();
        });
    </script>
</body>
</html>
